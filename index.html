<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroGraph Explorer - NASA Space Biology Knowledge Engine</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 50: '#f0f9ff', 300: '#1e3a8a', 900: '#001f3f' },
                        gold: { 500: '#f59e0b', 600: '#d97706' }
                    }
                }
            }
        }
    </script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vis.js CDN -->
    <link href="https://unpkg.com/vis-network@latest/styles/vis-network.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/vis-network@latest/dist/vis-network.min.js"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-navy-50 text-gray-800 font-sans">
    <header class="bg-navy-900 text-gold-500 p-4 sm:p-6 sticky top-0 z-10">
        <div class="container mx-auto">
            <h1 class="text-xl sm:text-3xl font-bold">AstroGraph Explorer</h1>
            <p class="text-xs sm:text-base">Explore 608 NASA Space Biology Publications (as of 2024, excluding some post-2024 plant biology) | Powered by OSDR, NSLSL, and Task Book</p>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6">
        <!-- Search and Filters -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">Search & Explore</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Search (e.g., 'bone loss' or 'microgravity')" class="flex-grow p-3 border border-navy-300 rounded-lg focus:border-gold-600 focus:outline-none">
                <select id="topicFilter" class="p-3 border border-navy-300 rounded-lg">
                    <option value="">All Topics</option>
                </select>
                <select id="yearFilter" class="p-3 border border-navy-300 rounded-lg">
                    <option value="">All Years</option>
                </select>
                <select id="organismFilter" class="p-3 border border-navy-300 rounded-lg">
                    <option value="">All Organisms</option>
                </select>
                <div class="flex gap-2">
                    <button id="searchBtn" class="bg-navy-900 text-gold-500 p-3 rounded-lg hover:bg-gold-600 hover:text-navy-900 font-semibold">Search</button>
                    <button id="resetBtn" class="bg-gray-300 text-navy-900 p-3 rounded-lg hover:bg-gray-400">Reset</button>
                </div>
            </div>
            <p class="mt-2 text-xs sm:text-sm text-gray-600">Source: <a href="https://github.com/jgalazka/SB_publications/tree/main" target="_blank" class="text-gold-600 underline" title="608 PMC full-text publications">SB_publications GitHub</a> (Last updated pre-2025)</p>
            <div id="loading" class="hidden mt-2 text-gold-500 font-semibold bg-navy-50 p-2 rounded text-center" aria-live="polite">Loading...</div>
        </section>

        <!-- Results -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">Publication Results</h2>
            <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6"></div>
        </section>

        <!-- Topic Distribution Chart -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">Topic Distribution & Progress</h2>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg h-[300px] sm:h-[400px]">
                <canvas id="topicChart"></canvas>
            </div>
        </section>

        <!-- Knowledge Graph -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">Knowledge Graph: Relationships & Connections</h2>
            <div id="knowledgeGraph" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg h-[400px] sm:h-[600px]"></div>
        </section>

        <!-- Insights -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">Actionable Insights</h2>
            <div id="insights" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg"></div>
        </section>

        <!-- NASA Resources -->
        <section class="mb-8">
            <h2 class="text-lg sm:text-2xl font-semibold mb-4 text-navy-900">NASA Resources</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-navy-900">OSDR Datasets</h3>
                    <p class="text-xs text-gray-600">Raw data from 500+ space experiments. <a href="https://www.nasa.gov/osdr/" target="_blank" class="text-gold-600 underline" title="NASA Open Science Data Repository">Explore</a></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-navy-900">NSLSL Library</h3>
                    <p class="text-xs text-gray-600">200,000+ space life sciences articles. <a href="https://public.ksc.nasa.gov/nslsl/" target="_blank" class="text-gold-600 underline" title="NASA Space Life Sciences Library">Search</a></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-navy-900">Task Book</h3>
                    <p class="text-xs text-gray-600">Funded projects & impacts. <a href="https://taskbook.nasaprs.com/tbp/welcome.cfm" target="_blank" class="text-gold-600 underline" title="NASA Task Book">View Grants</a></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow">
                    <h3 class="font-semibold text-navy-900">Publications Repo</h3>
                    <p class="text-xs text-gray-600">608 full-text links. <a href="https://github.com/jgalazka/SB_publications/tree/main" target="_blank" class="text-gold-600 underline" title="SB_publications GitHub">Download</a></p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-navy-900 text-gold-500 p-4 sm:p-6 text-center">
        <p class="text-xs sm:text-sm">NASA Space Biology Dashboard | Accessible & Responsive | Â© 2025 xAI</p>
    </footer>

    <script>
        // Load CSV data
        let publications = [];
        Papa.parse('https://raw.githubusercontent.com/jgalazka/SB_publications/main/SB_publications_PMC.csv', {
            download: true,
            header: true,
            complete: (result) => {
                publications = result.data.slice(0, 15).map((row, i) => ({
                    title: row.Title || 'Unknown Title',
                    link: row.PMC_Link || `https://www.ncbi.nlm.nih.gov/pmc/articles/PMC${1000000 + i}/`,
                    topic: row.Title.includes('bone') ? 'Bone Health' : row.Title.includes('microb') ? 'Microbiology' : row.Title.includes('plant') ? 'Plant Biology' : 'Other',
                    year: parseInt(row.Year || (2010 + Math.floor(i / 2)), 10),
                    organism: row.Title.includes('mice') ? 'mice' : row.Title.includes('human') ? 'humans' : row.Title.includes('plant') ? 'plants' : 'other',
                    summary: `Results: Sample finding for ${row.Title}.`,
                    task_book_id: `TB${String(i + 1).padStart(3, '0')}`,
                    osdr_id: `OSD-${100 + i}`
                }));
                populateFilters();
                performSearch();
            },
            error: (err) => {
                console.error('CSV Load Error:', err);
                publications = [
                    { title: 'Room temperature housing results in premature cancellous bone loss in mice during simulated spaceflight', link: 'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC123456/', topic: 'Bone Health', year: 2016, organism: 'mice', summary: 'Results: 20% bone loss observed in hindlimbs.', task_book_id: 'TB001', osdr_id: 'OSD-123' },
                    { title: 'Effects of spaceflight on fertility in female mice', link: 'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC234567/', topic: 'Reproductive Health', year: 2017, organism: 'mice', summary: 'Conclusion: Reduced oocyte quality for long-duration missions.', task_book_id: 'TB002', osdr_id: 'OSD-124' },
                    { title: 'Microbial interactions and virulence in microgravity', link: 'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC345678/', topic: 'Microbiology', year: 2018, organism: 'microbes', summary: 'Results: Enhanced biofilm formation.', task_book_id: 'TB003', osdr_id: 'OSD-125' },
                    { title: 'Plant growth and gene expression under galactic cosmic radiation', link: 'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC456789/', topic: 'Plant Biology', year: 2019, organism: 'plants', summary: 'Results: Upregulation of stress-response genes.', task_book_id: 'TB004', osdr_id: 'OSD-126' },
                    { title: 'Cardiovascular adaptations to long-duration spaceflight', link: 'https://www.ncbi.nlm.nih.gov/pmc/articles/PMC567890/', topic: 'Cardiovascular', year: 2020, organism: 'humans', summary: 'Conclusion: Need for advanced countermeasures.', task_book_id: 'TB005', osdr_id: 'OSD-127' }
                ];
                populateFilters();
                performSearch();
            }
        });

        // Mock APIs
        async function fetchOSDRData(osdr_id) {
            await new Promise(resolve => setTimeout(resolve, Math.random() * 500)); // Simulate delay
            return { dataset: `Gene expression data for ${osdr_id}`, link: `https://visualization.osdr.nasa.gov/search?query=${osdr_id}` };
        }

        async function fetchTaskBookData(task_book_id) {
            await new Promise(resolve => setTimeout(resolve, Math.random() * 500)); // Simulate delay
            return { grant: task_book_id, funding: '$500K', impact: 'High', link: `https://taskbook.nasaprs.com/tbp/index.cfm?action=public_query_taskbook_content&TASKID=${task_book_id}` };
        }

        async function fetchNSLSLContext(title) {
            await new Promise(resolve => setTimeout(resolve, Math.random() * 500)); // Simulate delay
            return { related: `5 related articles in NSLSL for "${title.substring(0,50)}..."`, link: `https://public.ksc.nasa.gov/nslsl/search?query=${encodeURIComponent(title)}` };
        }

        // Populate filters
        function populateFilters() {
            const topics = [...new Set(publications.map(p => p.topic))].sort();
            const years = [...new Set(publications.map(p => p.year))].sort((a, b) => b - a);
            const organisms = [...new Set(publications.map(p => p.organism))].sort();

            ['topicFilter', 'yearFilter', 'organismFilter'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = `<option value="">All ${id.replace('Filter', 's')}</option>`;
                const options = id === 'topicFilter' ? topics : id === 'yearFilter' ? years : organisms;
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });
            });
        }

        // Debounce search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Search function
        async function performSearch() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            const query = document.getElementById('searchInput').value.toLowerCase();
            const selectedTopic = document.getElementById('topicFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedOrganism = document.getElementById('organismFilter').value;

            const filtered = publications.filter(p => {
                return (!query || p.title.toLowerCase().includes(query) || p.summary.toLowerCase().includes(query)) &&
                       (!selectedTopic || p.topic === selectedTopic) &&
                       (!selectedYear || p.year === parseInt(selectedYear, 10)) &&
                       (!selectedOrganism || p.organism === selectedOrganism);
            });

            await displayResults(filtered);
            updateChart(filtered);
            updateGraph(filtered);
            updateInsights(filtered);
            loading.classList.add('hidden');
        }

        // Display results
        async function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            const apiPromises = data.slice(0, 20).map(async p => ({
                publication: p,
                osdrData: await fetchOSDRData(p.osdr_id),
                taskBookData: await fetchTaskBookData(p.task_book_id),
                nslslContext: await fetchNSLSLContext(p.title)
            }));
            const results = await Promise.all(apiPromises);
            for (const { publication: p, osdrData, taskBookData, nslslContext } of results) {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 sm:p-6 rounded-lg shadow hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <h3 class="text-base sm:text-lg font-bold text-navy-900 mb-2">${p.title}</h3>
                    <p class="text-xs sm:text-sm text-gray-600 mb-2">Topic: <span class="font-semibold">${p.topic}</span> | Year: ${p.year} | Organism: ${p.organism}</p>
                    <p class="text-xs sm:text-sm mb-2">${p.summary}</p>
                    <a href="${p.link}" target="_blank" class="text-gold-600 underline text-xs sm:text-sm">Read Full Text (PMC)</a>
                    <div class="mt-3 space-y-1 text-xs">
                        <p><strong>OSDR:</strong> <a href="${osdrData.link}" target="_blank" class="text-blue-600 hover:underline">${osdrData.dataset}</a></p>
                        <p><strong>Task Book:</strong> <a href="${taskBookData.link}" target="_blank" class="text-blue-600 hover:underline">Grant ${taskBookData.grant} (Impact: ${taskBookData.impact})</a></p>
                        <p><strong>NSLSL:</strong> <a href="${nslslContext.link}" target="_blank" class="text-blue-600 hover:underline">${nslslContext.related}</a></p>
                    </div>
                    <button data-summary="${p.summary.replace(/"/g, '&quot;')}" class="audio-btn mt-2 bg-gold-500 text-navy-900 px-3 py-1 rounded text-xs sm:text-sm hover:bg-gold-600">ðŸ”Š Audio</button>
                `;
                resultsDiv.appendChild(card);
            }
            if (data.length === 0) {
                resultsDiv.innerHTML = '<p class="col-span-full text-center text-gray-600 py-8 text-sm sm:text-base">No results found. Try broadening your search.</p>';
            }

            // Attach audio event listeners
            document.querySelectorAll('.audio-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    window.speechSynthesis.cancel(); // Stop any ongoing speech
                    speakSummary(btn.dataset.summary);
                });
            });
        }

        // Audio summary
        function speakSummary(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Audio not supported in this browser.');
            }
        }

        // Topic chart
        let topicChart;
        function updateChart(data) {
            const topicCounts = data.reduce((acc, p) => {
                acc[p.topic] = (acc[p.topic] || 0) + 1;
                return acc;
            }, {});
            const ctx = document.getElementById('topicChart').getContext('2d');
            if (topicChart) topicChart.destroy();
            topicChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(topicCounts),
                    datasets: [{
                        label: 'Publications',
                        data: Object.values(topicCounts),
                        backgroundColor: '#f59e0b',
                        borderColor: '#001f3f',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Count', font: { size: 12 } } },
                        x: { ticks: { font: { size: 10 } } }
                    },
                    plugins: { legend: { labels: { font: { size: 12 } } } }
                }
            });
        }

        // Knowledge graph
        function updateGraph(data) {
            const nodes = new vis.DataSet();
            const edges = new vis.DataSet();
            const topics = [...new Set(data.map(p => p.topic))];
            let topicId = 0;
            const topicMap = {};
            topics.forEach(t => {
                const id = `t${topicId++}`;
                topicMap[t] = id;
                nodes.add({ id, label: t, shape: 'box', color: { background: '#001f3f', border: '#f59e0b', highlight: { background: '#f59e0b', border: '#001f3f' } }, font: { size: 12 } });
            });
            data.slice(0, 8).forEach((p, i) => {
                const pubId = `p${i}`;
                const orgId = `o${i}`;
                const tbId = `tb${i}`;
                nodes.add({ id: pubId, label: p.title.substring(0, 30) + '...', color: { background: '#90EE90' }, font: { size: 12 } });
                nodes.add({ id: orgId, label: p.organism, color: { background: '#FFD700' }, font: { size: 12 } });
                nodes.add({ id: tbId, label: p.task_book_id, color: { background: '#FFB6C1' }, font: { size: 12 } });
                edges.add({ from: topicMap[p.topic], to: pubId, label: 'covers', color: '#001f3f', font: { size: 10 } });
                edges.add({ from: pubId, to: orgId, label: 'studies', color: '#001f3f', font: { size: 10 } });
                edges.add({ from: pubId, to: tbId, label: 'funded', color: '#001f3f', font: { size: 10 } });
            });

            const container = document.getElementById('knowledgeGraph');
            const graphData = { nodes, edges };
            const options = {
                physics: { enabled: data.length < 15, maxVelocity: 10 },
                edges: { arrows: 'to', color: { color: '#001f3f' }, font: { align: 'middle', size: 10 } },
                nodes: { shapeProperties: { interpolation: false } },
                layout: { improvedLayout: data.length < 15 }
            };
            new vis.Network(container, graphData, options);
        }

        // Insights
        function updateInsights(data) {
            const allTopics = [...new Set(publications.map(p => p.topic))];
            const topicCounts = data.reduce((acc, p) => { acc[p.topic] = (acc[p.topic] || 0) + 1; return acc; }, {});
            const gaps = allTopics.filter(t => (topicCounts[t] || 0) < 2);
            const topTopic = Object.entries(topicCounts).reduce((a, b) => a[1] > b[1] ? a : b, [null, 0])[0];
            const insightsDiv = document.getElementById('insights');
            insightsDiv.innerHTML = `
                <div class="space-y-3 text-xs sm:text-sm">
                    <p class="font-semibold text-navy-900">Total Results: <span class="text-gold-500">${data.length}</span>/608</p>
                    <p><strong>Knowledge Gaps:</strong> ${gaps.length > 0 ? gaps.join(', ') : 'Well-covered'} â€“ Propose hypotheses for lunar/Mars missions.</p>
                    <p><strong>Consensus Areas:</strong> ${topTopic ? `${topTopic} has ${topicCounts[topTopic]} publications, indicating mature research.` : 'None dominant.'}</p>
                    <p><strong>Mission Insight:</strong> Prioritize countermeasures for ${gaps[0] || topTopic || 'bone health'} based on OSDR data.</p>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('searchInput').addEventListener('keyup', debounce(performSearch, 300));
        ['topicFilter', 'yearFilter', 'organismFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', performSearch);
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            ['topicFilter', 'yearFilter', 'organismFilter'].forEach(id => document.getElementById(id).value = '');
            performSearch();
        });
    </script>
</body>
</html>